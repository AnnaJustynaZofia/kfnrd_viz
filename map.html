<!DOCTYPE html>
<meta charset="utf-8">
<style>

.poland {
  /*cursor: crosshair;*/
}

.city {
  /*cursor: crosshair;*/
  fill: rgba(255, 0, 0, 0.2);
  stroke: rgba(0, 0, 0, 0.5);
  stroke-width: 0px;
}

.city:hover {
  stroke-width: 1px;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>

var width = 960,
    height = 1160;

var projection = d3.geo.mercator()
    .center([20, 52])
    .scale(3000)
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var ludzie_do_miast = function (ludzie) {
  var dict = {};
  var d, miasto_woj;
  for (var i = 0; i < ludzie.length; i++) {
    d = ludzie[i];
    miasto_woj = d.miejscowosc + ", woj. " + d.wojewodztwo;
    // uzywac 'poczta', a nie 'miejscowosc'
    if (miasto_woj in dict) {
      dict[miasto_woj].osoby += 1;
    } else {
      dict[miasto_woj] = {osoby: 1, lng: +d.lng, lat: +d.lat};
    }
  }
  var res = [];
  for (var k in dict) {
    d = dict[k];
    res.push({miasto_woj: k, osoby: d.osoby, lng: d.lng, lat: d.lat})
  };
  return res.sort(function (a, b) {
    return b.osoby - a.osoby;
  });
}

d3.json("poland_border_coarse.topo.json", function(error_poland, poland) {
  d3.csv("demografia2005.csv", function(error_dem, data) {

    svg.append("path")
        .datum(topojson.feature(poland, poland.objects.poland_border_coarse))
        .attr("d", path)
        .attr("class", "poland")
        .style("fill", "steelblue");

    svg.selectAll('.city')
      .data(ludzie_do_miast(data))
      .enter()
        .append("circle")
          .attr("class", "city")
          .attr("cx", function (d) { return projection([d.lng, d.lat])[0]; })
          .attr("cy", function (d) { return projection([d.lng, d.lat])[1]; })
          .attr("r", function (d) { return 3 * Math.sqrt(d.osoby); })
          .append("title")
            .text(function (d) { return d.miasto_woj; });
  })
});



</script>
