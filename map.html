<!DOCTYPE html>
<meta charset="utf-8">
<style>

.poland {
  /*cursor: crosshair;*/
}

.city {
  /*cursor: crosshair;*/
  fill: rgba(255, 0, 0, 0.2);
  stroke: rgba(0, 0, 0, 0.5);
  stroke-width: 0px;
}

.city:hover {
  stroke-width: 1px;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script>


var width = 960,
    height = 1160;

var projection = d3.geo.mercator()
    .center([20, 52])
    .scale(3000)
    .translate([400, 350]);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);


function miejsce_id (d) {
  return d.miejscowosc + ", woj. " + d.wojewodztwo;
}


var ludzie_do_miast = function (ludzie) {
  var dict = {};
  var d, miasto_woj;
  for (var i = 0; i < ludzie.length; i++) {
    d = ludzie[i];
    miasto_woj = miejsce_id(d);
    //
    // uzywac 'poczta', a nie 'miejscowosc'
    //
    if (miasto_woj in dict) {
      dict[miasto_woj].osoby += 1;
    } else {
      dict[miasto_woj] = {osoby: 1, lng: +d.lng, lat: +d.lat};
    }
  }
  var res = [];
  for (var k in dict) {
    d = dict[k];
    res.push({miasto_woj: k, osoby: d.osoby, lng: d.lng, lat: d.lat})
  };
  return res.sort(function (a, b) {
    return b.osoby - a.osoby;
  });
}


var ludzie_do_miast_zliczenia = function (ludzie) {
  var dict = {};
  var d, miasto_woj;
  for (var i = 0; i < ludzie.length; i++) {
    d = ludzie[i];
    miasto_woj = miejsce_id(d);
    //
    // uzywac 'poczta', a nie 'miejscowosc'
    //
    if (miasto_woj in dict) {
      dict[miasto_woj] += 1;
    } else {
      dict[miasto_woj] = 1;
    }
  }
  return dict;
}


var ludzie_do_dziedzin = function (ludzie) {
  var dict = {};
  var d;
  for (var i = 0; i < ludzie.length; i++) {
    d = ludzie[i];
    dziedzina = d.dziedzina;
    if (dziedzina in dict) {
      dict[dziedzina].osoby += 1;
    } else {
      dict[dziedzina] = {osoby: 1};
    }
  }
  var res = [];
  for (var k in dict) {
    d = dict[k];
    res.push({dziedzina: k, osoby: d.osoby})
  };
  return res.sort(function (a, b) {
    return b.osoby - a.osoby;
  });
}


var ludzie_do_dziedzin_zliczenia = function (ludzie) {
  var dict = {};
  var d;
  for (var i = 0; i < ludzie.length; i++) {
    d = ludzie[i];
    dziedzina = d.dziedzina;
    if (dziedzina in dict) {
      dict[dziedzina] += 1;
    } else {
      dict[dziedzina] = 1;
    }
  }
  return dict;
}


d3.json("poland_border_coarse.topo.json", function(error_poland, poland_data) {
  d3.csv("demografia2005.csv", function(error_dem, people_data) {
    zacznij_wizualizajce(poland_data, people_data);
  })
});


function zacznij_wizualizajce (poland_data, people_data) {

  svg.append("path")
      .datum(topojson.feature(poland_data, poland_data.objects.poland_border_coarse))
      .attr("d", path)
      .attr("class", "poland")
      .style("fill", "steelblue");

  odswiez_rok(people_data, 2005);

}


function odswiez_rok (people_data, rok) {

  var miasta = svg.selectAll('.city')
    .data(ludzie_do_miast(people_data));

  miasta.enter()
    .append("circle")
      .attr("class", "city")
      .attr("cx", function (d) { return projection([d.lng, d.lat])[0]; })
      .attr("cy", function (d) { return projection([d.lng, d.lat])[1]; })
      .attr("r", 0)
      .on("mouseover", function (d) { wyswietl_dziedziny_w_miescie(dziedziny, people_data, d); })
      .on("mouseout", function (d) { wyswietl_dziedziny_wszystkie(dziedziny); })
      .append("title")
        .text(function (d) { return d.miasto_woj; });

  miasta.transition()
    .duration(1000)
      .attr("r", function (d) { return 3 * Math.sqrt(d.osoby); });

  var dziedziny = svg.selectAll('.dziedzina')
    .data(ludzie_do_dziedzin(people_data));

  dziedziny.enter()
    .append("text")
      .attr("class", "dziedzina")
      .on("mouseover", function (d) { wyswietl_miasta_w_dziedzinie(miasta, people_data, d); })
      .on("mouseout", function (d) { wyswietl_miasta_wszystkie(miasta); })
      .attr("x", 700)
      .attr("y", function (d, i) { return 100 + 20 * i; });

  wyswietl_dziedziny_wszystkie(dziedziny);

}


function wyswietl_dziedziny_wszystkie (dziedziny) {

  dziedziny
    .style("opacity", 1)
    .text(function (d) {
      return [d.osoby, d.dziedzina].join(" ");
    });

}


function wyswietl_dziedziny_w_miescie (dziedziny, people_data, d) {

  var czesc_ludzi = people_data.filter(function (c) { return miejsce_id(c) == d.miasto_woj; });

  var dziedziny_w_miescie = ludzie_do_dziedzin_zliczenia(czesc_ludzi);

  dziedziny
    .style("opacity", function (d) {
      return dziedziny_w_miescie[d.dziedzina] ? 1 : 0.3;
    })
    .text(function (d) {
      return [dziedziny_w_miescie[d.dziedzina] || "", d.dziedzina].join(" ");
    });

}


function wyswietl_miasta_wszystkie (miasta) {

  miasta
    .attr("r", function (d) { return 3 * Math.sqrt(d.osoby); });

}


function wyswietl_miasta_w_dziedzinie (miasta, people_data, d) {

  var czesc_ludzi = people_data.filter(function (c) { return c.dziedzina == d.dziedzina; });

  var miasta_w_dziedzinie = ludzie_do_miast_zliczenia(czesc_ludzi);

  miasta
    .attr("r", function (d) { return 3 * Math.sqrt(miasta_w_dziedzinie[d.miasto_woj] || 0); });

}


</script>
